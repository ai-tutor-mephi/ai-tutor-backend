# AI Tutor Backend API - Документация для Frontend
Этот документ описывает API для взаимодействия с бэкендом проекта AI Tutor.

## 1. Общая информация
- **Базовый URL:** `http://localhost:8080` (для локальной разработки)
- **Формат данных:** Все тела запросов и ответов используют формат `application\json`, если не указано иное.
- **Аутентификация:** Все эндпоинты, кроме `"/api/auth/register", "/api/auth/login", "/api/auth/refresh"`, требуют аутентификации. Для этого необходимо передавать JWT-токен в заголовке `Authorization`.
    - **Формат заголовка:** `Authorization: Bearer <jwt_токен>`

## 2. Аутентификация

Эндпоинты для регистрации и входа в систему.

### 2.1. Регистрация нового пользователя

Создает нового пользователя в системе.

- **Эндпоинт:** `POST /api/auth/register`
- **Тип запроса:** `application/json`
- **Тело запроса:**
  ```json  
  {  
    "userName": "testuser",    
    "email": "user@example.com",    
    "password": "testpassword"  
  }  
    ```

### 2.2. Вход нового пользователя  

Авторизация пользователя, у которого уже существует аккаунт.

- **Эндпоинт:** `POST /api/auth/login`  
- **Тип запроса:** `application/json`  
- **Тело запроса:**  
  ```json  
  {  
    "userName": "testuser",      
    "password": "testpassword"  
	}  
```
- **Ответ:**
  ```json
  {
	  "access_token": "...",
	  "refresh_token": "..."
  }
  ```
access_token представляет собой JWT, живет 15 минут, refresh живет 30 дней.
Как с этим работать? Refresh нужно куда-то сохранить на стороне фронта, например, в localStorage или в httpOnly cookie , на стороне бэка он хранится в бд. Access_token используется для аутентификации при запросах. По истечении его срока годности при попытке доступа к эндпоинту, который требует авторизации, а это все эндпоинты /api/auth/**, возвращается **401 Unauthorized**, на стороне фронтенда она попадает в обработчик ошибок, фронтенд берет refreshToken из localStorage и обращается к эндпоинту POST /api/auth/refresh, получая новую пару токенов, если срок refresh токена истек, то нужно заново логинится, в ответ придет 403 Forbidden.

### 2.3. Получение новой пары токенов

**Эндпоинт:** `POST /api/auth/refresh`
- **Тип запроса:** `application/json`
- **Тело запроса:**
```json
{
	"refreshToken": "..."
}
```
- **Ответ:**
  ```json
  {
	  "accessToken": "...",
	  "refreshToken": "..."
  }
  ```

### 2.4. Выход пользователя из аккаунта

Делает текущий refreshToken недействительным. Требует наличия валидного accessToken для идентификации пользователя.

- **Эндпоинт:** `POST /api/auth/logout`
- **Тип запроса:** `application/json`
- **Тело запроса:** empty
- **Ответ:** 200 OK, Тело: "User logged out successfully!"

## 3. Диалоги

### 3.1. Создание нового диалога с файлом

Загружает первый файл и создает на его основе новый диалог.
- **Эндпоинт:** `POST /api/dialogs/with-file`
- **Описание:** Загружает первый файл и создает на его основе новый диалог.
- **Тип запроса:** `multipart/form-data`
- **Тело запроса:** Поле с ключом file и типом File.
- **Успешный ответ (201 Created):**
    ```json
    {
      "dialogId": 1,
      "title": "имя_загруженного_файла.pdf"
    }
    ```
- **Ошибки:**
    - 413 Payload Too Large (если файл превышает лимит).
    - 500 Internal Server Error (если произошла ошибка при сохранении).

### 3.2. Добавление файла в существующий диалог

Загружает дополнительный файл в контекст существующего диалога.
- **Эндпоинт:** `POST /api/dialogs/{dialogId}/files`
- **Тип запроса:** `multipart/form-data`
- **Тело запроса:** Поле с ключом file и типом File.
- **Успешный ответ (201 Created):**
    ```json
    {
      "fileId": 101,
      "originalFileName": "дополнительный_файл.docx",
      "dialogId": 1
    }
    ```
- **Ошибки:**
    - 404 Not Found (если диалог с dialogId не найден).
    - 403 Forbidden (если диалог не принадлежит текущему пользователю).

# Инструкция по запуску приложения в Docker

В корневой папке проект находится Dockerfile и docker-compose.yml.
Для запуска выполнить следующее.
- Склонировать проект на ПК
- В консоли перейти в корневую папку ai-tutor-backend, далее все команды прописываются в этой папке.
- Выполнить команду `mvn clean package -Dmaven.test.skip=true`. Эта команда собирает проект, флаг `-Dmaven.test.skip=true` отключает компиляцию и запуск тестов, иначе программа упадет, так как на момент ее компиляции БД еще не создана.
- Выполнить команду ` docker-compose up --build -d`. Создает сеть `ai_tutor_network` и создает в ней контейнеры `ai-tutor-db`, `ai-tutor-minio`, `ai-tutor-app`. Флаг -d позволяет продолжать пользоваться консолью.
- Далее перед загрузкой файлов необходимо перейти по адресу http://localhost:9001 на этом порте разворачивается MinIO, необходимо авторизоваться: login - minioadmin, password - minioadmin. Далее необходимо создать там bucket, назвав его `ai-tutor-files` (важно чтобы название было в точности таким). После этого приложение сможет работать с хранилищем. На данный момент максимальный размер файла, доступного для загрузки, 10Мб, а максимальный размер запроса 1Гб. Также на странице MinIO можно отслеживать загруженные файлы.
- Чтобы увидеть логи самого приложения необходимо выполнить команду `docker-compose logs -f app`.
- Для полного завершения работы и очистки окружения необходимо выполнить `docker-compose down -v`. Флаг -v удаляет не только контейнеры, но и volumes, в которых хранятся данные PostgreSQL и MinIO, в противном случае возможны ошибки при повторном запуске.